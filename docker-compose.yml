services:
  auth-service:
    build: .
    container_name: wgg_auth_service
    ports:
      - "8001:8001"
    env_file:
      - .env
    environment:
      - DATABASE_URL_AUTH=${DATABASE_URL}
      - AUTH_SECRET_KEY=${AUTH_SECRET_KEY}
    depends_on:
      mysql-db:
        condition: service_healthy
    command: sh -c "python -m app.create_admin && uvicorn app.main:app --reload --host 0.0.0.0 --port 8001"

  mysql-db:
    image: mysql:8.0
    container_name: wgg_auth_db
    env_file:
      - .env
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    ports:
      - "3307:3306" # Exposto na 3307 para n√£o conflitar com o outro banco
    volumes:
      - auth_db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysql", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}", "-D", "${MYSQL_DATABASE}", "-e", "select 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

volumes:
  auth_db_data: